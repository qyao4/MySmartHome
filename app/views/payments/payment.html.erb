<%# app/views/orders/payment.html.erb %>
<!-- <%= @order.inspect %> -->
<script src="https://js.stripe.com/v3/"></script>

<h1>Payment for Order <%= @order.id %></h1>

<div class="order-details">
  <h2>Order Summary</h2>
  <ul>
    <li>Address: <%= @order.address %></li>
    <li>City: <%= @order.city %></li>
    <li>Province: <%= Province.find(@order.province_id).name %></li>
    <li>Postal Code: <%= @order.post_code %></li>
    <li>Total Price: $<%= "%.2f" % @order.total_with_taxes %></li>
  </ul>
  <button id="checkout-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Checkout</button>
</div>


<script>
  var stripe = Stripe('<%= Rails.application.credentials.stripe[:publishable_key] %>');
  var checkoutButton = document.getElementById('checkout-button');

  checkoutButton.addEventListener('click', function () {

    fetch('<%= payment_session_path %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': '<%= form_authenticity_token %>'
      },
      body: JSON.stringify({order_id: <%= @order.id %>})
    })
    .then(function (response) {
      return response.json();
    })
    .then(function (data) {
      return stripe.redirectToCheckout({ sessionId: data.sessionId });
    })
    .then(function (result) {
      if (result.error) {
        alert(result.error.message);
      }
    })
    .catch(function (error){
      console.error('Error',error);
    });
  });
</script>